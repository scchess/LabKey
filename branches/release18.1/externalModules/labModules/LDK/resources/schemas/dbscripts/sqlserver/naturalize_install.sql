/*
    Naturalize() is designed to provide a value to use for 'natural sorting' of data, which provides a
    more human-friendly sorting of mixed numeric/text values.  Adapted from code here:

    http://stackoverflow.com/questions/34509/natural-human-alpha-numeric-sort-in-microsoft-sql-2005

    The C# file used to create the assembly is checked in to this module under /tools.  Tested in SQLServer 2008R2.
*/
SET NOCOUNT ON ;
GO

-------------------------------------------------------------------------------------------------------------------------------
-- Turn advanced options on
EXEC sys.sp_configure @configname = 'show advanced options', @configvalue = 1 ;
GO
RECONFIGURE WITH OVERRIDE ;
GO
-- Enable CLR
EXEC sys.sp_configure @configname = 'clr enabled', @configvalue = 1 ;
GO
RECONFIGURE WITH OVERRIDE ;
GO

-- Add trusted assembly if we are running on SQLServer 2017
IF OBJECT_ID(N'sys.trusted_assemblies', N'V') IS NOT NULL
BEGIN
  DECLARE @hash VARBINARY(64) = 0xAB53701DA71A00CFA24EA54B395E8CE943E23331A285B12651BB9B5374FBC454F65673C3DCF8223ACD8184812F41179B2A66F463C7A60C2F8F3BDD8B28F65D25;
  DECLARE @description NVARCHAR(4000) = N'Naturalize, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';

  IF NOT EXISTS (SELECT * FROM sys.trusted_assemblies WHERE hash = @hash)
    EXEC sys.sp_add_trusted_assembly @hash, @description

END
GO

-------------------------------------------------------------------------------------------------------------------------------
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, QUOTED_IDENTIFIER ON;
SET CONCAT_NULL_YIELDS_NULL, NUMERIC_ROUNDABORT OFF;
GO
IF EXISTS (SELECT * FROM tempdb..sysobjects WHERE id=OBJECT_ID('tempdb..#tmpErrors')) DROP TABLE #tmpErrors
GO
CREATE TABLE #tmpErrors (Error int)
GO
SET XACT_ABORT ON
GO
SET TRANSACTION ISOLATION LEVEL READ COMMITTED
GO
BEGIN TRANSACTION
GO
-------------------------------------------------------------------------------------------------------------------
PRINT N'Creating [Naturalize]...';
GO
IF object_id(N'ldk.Naturalize', N'FS') IS NOT NULL
  DROP FUNCTION ldk.Naturalize
GO

IF  EXISTS (SELECT * FROM sys.assemblies asms WHERE asms.name = N'Naturalize' and is_user_defined = 1)
  DROP ASSEMBLY [Naturalize]
GO
CREATE ASSEMBLY [Naturalize]
AUTHORIZATION [dbo]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300834DF5510000000000000000E00002210B010B00000A00000006000000000000DE280000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000902800004B00000000400000B002000000000000000000000000000000000000006000000C000000582700001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000E408000000200000000A000000020000000000000000000000000000200000602E72737263000000B00200000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001000000000000000000000000000004000004200000000000000000000000000000000C0280000000000004800000002000500F82100006005000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001330040065010000010000110002280500000A16FE01130A110A2D0D02280600000A130938450100002B1202720100007072070000706F0700000A10000272010000706F0800000A130A110A2DDD160A160B160C160D026F0900000A20E8030000320720E80300002B06026F0900000A001304730A00000A13051613062B7D000211066F0B00000A130711071F30320811071F39FE022B011700130A110A2D180006130A110A2D0A0011060C170D170A2B440917580D2B3E0616FE01130A110A2D1C0011050208096F0C00000A071F1928020000066F0D00000A26160A0011071F2EFE010B11050211066F0B00000A6F0E00000A260011061758130611061104FE04130A110A3A74FFFFFF0616FE01130A110A2D1811050208096F0C00000A071F1928020000066F0D00000A2611056F0F00000A130811086F0900000A20E8030000FE0216FE01130A110A2D1611081620E80300006F0C00000A280600000A13092B0B1108280600000A13092B0011092A000000133003001E0000000300001100032D0B02041F306F1000000A2B0902041F306F1100000A000A2B00062A1E02281200000A2A000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000A8010000237E000014020000E801000023537472696E677300000000FC0300000C0000002355530008040000100000002347554944000000180400004801000023426C6F620000000000000002000001471502000900000000FA2533001600000100000009000000020000000300000004000000120000000400000003000000010000000200000000000A0001000000000006002D0026000A00550040000600A90096000F00BD0000000600EC00CC0006000C01CC000A0045012A0106005A0126000600A30197010000000001000000000001000100010010001900000005000100010050200000000096005F000A000100C4210000000091006A0010000200EE21000000008618740017000500000001007A00000001007E00000002008200000003008C00190074001B0029007400210031007400170039007400170041006101CA0011006F010A0041007B01CF0041008301D50041008C01DA004900740017004100B101DE004100BB01E3004900C501E9004900C501EF000900CC01F5004100D5010C014100DD010C010900740017002000230026002E000B0016012E0013001F012E001B002801F900090112010480000000000000000000000000000000005F00000002000000000000000000000001001D000000000002000000000000000000000001003400000000000000003C4D6F64756C653E004E61747572616C697A652E646C6C00554446006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E67004E61747572616C697A65005061644E756D626572002E63746F720076616C006E756D006973446563696D616C007061644C656E6774680053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E41747472696275746500537472696E670049734E756C6C4F72456D707479006F705F496D706C69636974005265706C61636500436F6E7461696E73006765745F4C656E6774680053797374656D2E5465787400537472696E674275696C646572006765745F436861727300537562737472696E6700417070656E6400546F537472696E67005061644C6566740050616452696768740000000005200020000003200000005F30E57B7C0CDE4E83E4C93E8221E7050008B77A5C561934E08905000111090E0600030E0E020803200001052001011111042001010880A2010002005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E697374696301040001020E0520020E0E0E042001020E0320000804200103080520020E080805200112250E0520011225030320000E0F070B0202080808122508080E1109020206080520020E08030307010E0801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000000834DF55100000000020000001C010000742700007409000052534453313B2E1C7A750D449347686BBFA2593A01000000633A5C55736572735C62696D6265725C446F63756D656E74735C56697375616C2053747564696F20323031335C50726F6A656374735C4461746162617365315C4461746162617365315C6F626A5C44656275675C4E61747572616C697A652E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B82800000000000000000000CE280000002000000000000000000000000000000000000000000000C02800000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000040000F00010049006E007400650072006E0061006C004E0061006D00650000004E00610074007500720061006C0069007A0065002E0064006C006C00000000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000048000F0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004E00610074007500720061006C0069007A0065002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000E03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE;

GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
  BEGIN
    ROLLBACK;
  END
IF @@TRANCOUNT = 0
  BEGIN
    INSERT  INTO #tmpErrors (Error)
      VALUES                 (1);
    BEGIN TRANSACTION;
  END
GO
-------------------------------------------------------------------------------------------------------------------
PRINT N'Creating ldk.[NATURALIZE]...';
GO
CREATE FUNCTION ldk.Naturalize(@val as nvarchar(max))
  RETURNS nvarchar(1000)
  EXTERNAL NAME Naturalize.UDF.Naturalize
GO
IF @@ERROR <> 0
   AND @@TRANCOUNT > 0
  BEGIN
    ROLLBACK;
  END
IF @@TRANCOUNT = 0
  BEGIN
    INSERT  INTO #tmpErrors (Error)
      VALUES                 (1);
    BEGIN TRANSACTION;
  END
GO

-------------------------------------------------------------------------------------------------------------------
IF EXISTS (SELECT * FROM #tmpErrors) ROLLBACK TRANSACTION
GO
IF @@TRANCOUNT>0 BEGIN
  PRINT N'The transacted portion of the database update succeeded.'
  COMMIT TRANSACTION
END
ELSE PRINT N'The transacted portion of the database update failed.'
GO
DROP TABLE #tmpErrors
-------------------------------------------------------------------------------------------------------------------
GO
